<%- include('../partials/header', { title: 'Create New Password - Next Step' }) %>

<style>
    .reset-card {
        border-radius: 12px;
        max-width: 400px;
        width: 100%;
        margin: 20px auto;
    }

    .password-requirements {
        font-size: 0.875rem;
    }

    @media (max-width: 400px) {
        .reset-card {
            padding: 1rem !important;
        }
        .reset-card h5 {
            font-size: 1rem;
        }
    }
</style>

<div class="container d-flex justify-content-center align-items-center" style="min-height: 70vh; padding-top: 20px;">
    <div class="card shadow p-4 reset-card">
        <div class="text-center mb-3">
            <i class="fas fa-lock fa-2x mb-2"></i>
            <h5>Create New Password</h5>
            <p class="text-muted">Your new password must be different from previously used passwords.</p>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger text-center">
            <%= error %>
        </div>
        <% } %>

        <form method="POST" action="/resetPassword" id="resetPasswordForm">
            <input type="hidden" name="email" value="<%= email %>" />
            
            <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <div class="input-group">
                    <input type="password" name="password" id="newPassword" 
                           class="form-control" placeholder="Enter new password" required />
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <div class="input-group">
                    <input type="password" name="confirmPassword" id="confirmPassword" 
                           class="form-control" placeholder="Confirm new password" required />
                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="password-requirements p-2 border rounded bg-light mb-3">
                <p class="mb-1"><strong>Password must contain:</strong></p>
                <ul class="mb-0 small" style="list-style-type: disc; padding-left: 1.5em;">
                    <li>At least 8 characters</li>
                    <li>One uppercase letter</li>
                    <li>One lowercase letter</li>
                    <li>One number</li>
                    <li>One special character</li>
                </ul>
            </div>

            <button type="submit" class="btn btn-dark w-100">Reset Password</button>

            <div class="text-center mt-3">
                <a href="/signin" class="text-decoration-none">
                    <i class="fas fa-arrow-left me-1"></i> Back to Login
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const passwordInput = document.getElementById('newPassword');
    const confirmInput = document.getElementById('confirmPassword');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');

    // Toggle password visibility
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
    });

    toggleConfirmPassword.addEventListener('click', function() {
        const type = confirmInput.type === 'password' ? 'text' : 'password';
        confirmInput.type = type;
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        let error = '';

        if (password.length < 8) {
            error = 'Password must be at least 8 characters.';
        } else if (!/[A-Z]/.test(password)) {
            error = 'Password must contain at least one uppercase letter.';
        } else if (!/[a-z]/.test(password)) {
            error = 'Password must contain at least one lowercase letter.';
        } else if (!/[0-9]/.test(password)) {
            error = 'Password must contain at least one number.';
        } else if (!/[^A-Za-z0-9]/.test(password)) {
            error = 'Password must contain at least one special character.';
        } else if (password !== confirm) {
            error = 'Passwords do not match.';
        }

        if (error) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Password',
                text: error,
                confirmButtonColor: '#212529'
            });
            return false;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

        // Submit form
        form.submit();
    });
});
</script>

<%- include('../partials/footer') %>
