<%- include('../partials/header', { title: 'Create Account - Next Step' }) %>
<%- include('../partials/navbar') %>

<style>
    .form-container {
        max-width: 500px;
        margin: 0 auto;
        background-color: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc3545;
    }

    .is-valid {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    }

    .password-requirements {
        font-size: 0.875rem;
    }
</style>

<div class="d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 60px); padding: 10px 0;">
    <section class="form-container">
        <h5 class="mb-4 text-center">Create Account</h5>

        <% if (error) { %>
        <div class="alert alert-danger text-center">
            <%= error %>
        </div>
        <% } %>

        <form method="POST" action="/signup" id="signupForm">
            <div class="row mb-3">
                <div class="col">
                    <input type="text" name="firstName" class="form-control" 
                           placeholder="First name" required />
                </div>
                <div class="col">
                    <input type="text" name="lastName" class="form-control" 
                           placeholder="Last name" required />
                </div>
            </div>

            <div class="mb-3">
                <input id="email" type="email" name="email" class="form-control" 
                       placeholder="Enter your email" required />
            </div>

            <div class="mb-3">
                <input type="tel" name="phone" class="form-control" 
                       placeholder="Enter your phone" required />
            </div>

            <div class="mb-3">
                <input id="password" type="password" name="password" class="form-control" 
                       placeholder="Create password" required />
            </div>

            <div class="mb-3">
                <input id="confirmPassword" type="password" name="confirmPassword" 
                       class="form-control" placeholder="Confirm password" required />
            </div>

            <div class="password-requirements p-2 border rounded bg-light mb-3">
                <p class="mb-1"><strong>Password must contain:</strong></p>
                <ul class="mb-0 small" style="list-style-type: disc; padding-left: 1.5em;">
                    <li>At least 8 characters</li>
                    <li>One uppercase letter</li>
                    <li>One lowercase letter</li>
                    <li>One number</li>
                    <li>One special character</li>
                </ul>
            </div>

            <div class="form-check mb-3 text-start">
                <input class="form-check-input" type="checkbox" name="termsAgreed" required />
                <label class="form-check-label">
                    I agree to the <a href="#">Terms of Service</a> and 
                    <a href="#">Privacy Policy</a>
                </label>
            </div>

            <div class="mb-3">
                <input type="text" name="referralCode" class="form-control" 
                       placeholder="Referral Code (optional)" />
                <div class="form-text">Have a referral code? Enter it here</div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-dark">Create Account</button>
            </div>
        </form>

        <p class="mt-3 text-center">
            Already have an account? <a href="/signin">Sign in</a>
        </p>
    </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("signupForm");

    // Validation functions
    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        let errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
    }

    function clearFieldError(field) {
        field.classList.remove('is-invalid');
        let errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
    }

    function validateName(name, fieldName) {
        if (!name.trim()) {
            return fieldName + ' is required';
        }
        if (name.trim().length < 2) {
            return fieldName + ' must be at least 2 characters';
        }
        if (name.trim().length > 50) {
            return fieldName + ' must be less than 50 characters';
        }
        if (!/^[a-zA-Z\s'-]+$/.test(name.trim())) {
            return fieldName + ' can only contain letters, spaces, hyphens, and apostrophes';
        }
        return null;
    }

    function validateEmail(email) {
        if (!email.trim()) {
            return 'Email is required';
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email.trim())) {
            return 'Please enter a valid email address';
        }
        return null;
    }

    function validatePhone(phone) {
        if (!phone.trim()) {
            return 'Phone number is required';
        }
        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(phone.trim())) {
            return 'Please enter a valid 10-digit mobile number';
        }
        return null;
    }

    function validatePassword(password) {
        if (!password) {
            return 'Password is required';
        }
        if (password.length < 8) {
            return 'Password must be at least 8 characters';
        }
        if (!/[A-Z]/.test(password)) {
            return 'Password must contain at least one uppercase letter';
        }
        if (!/[a-z]/.test(password)) {
            return 'Password must contain at least one lowercase letter';
        }
        if (!/[0-9]/.test(password)) {
            return 'Password must contain at least one number';
        }
        if (!/[^A-Za-z0-9]/.test(password)) {
            return 'Password must contain at least one special character';
        }
        return null;
    }

    // Get form fields
    const firstName = document.querySelector('input[name="firstName"]');
    const lastName = document.querySelector('input[name="lastName"]');
    const email = document.getElementById('email');
    const phone = document.querySelector('input[name="phone"]');
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirmPassword');
    const termsCheckbox = document.querySelector('input[name="termsAgreed"]');

    // Real-time validation
    firstName.addEventListener('blur', function() {
        const error = validateName(this.value, 'First name');
        if (error) {
            showFieldError(this, error);
        } else {
            clearFieldError(this);
        }
    });

    lastName.addEventListener('blur', function() {
        const error = validateName(this.value, 'Last name');
        if (error) {
            showFieldError(this, error);
        } else {
            clearFieldError(this);
        }
    });

    email.addEventListener('blur', function() {
        const error = validateEmail(this.value);
        if (error) {
            showFieldError(this, error);
        } else {
            clearFieldError(this);
        }
    });

    phone.addEventListener('blur', function() {
        const error = validatePhone(this.value);
        if (error) {
            showFieldError(this, error);
        } else {
            clearFieldError(this);
        }
    });

    password.addEventListener('input', function() {
        const error = validatePassword(this.value);
        if (error) {
            showFieldError(this, error);
        } else {
            clearFieldError(this);
        }

        if (confirmPassword.value) {
            if (this.value !== confirmPassword.value) {
                showFieldError(confirmPassword, 'Passwords do not match');
            } else {
                clearFieldError(confirmPassword);
            }
        }
    });

    confirmPassword.addEventListener('input', function() {
        if (password.value !== this.value) {
            showFieldError(this, 'Passwords do not match');
        } else {
            clearFieldError(this);
        }
    });

    // Form submission
    form.addEventListener("submit", function (e) {
        e.preventDefault();
        let hasErrors = false;

        // Validate all fields
        const firstNameError = validateName(firstName.value, 'First name');
        if (firstNameError) {
            showFieldError(firstName, firstNameError);
            hasErrors = true;
        } else {
            clearFieldError(firstName);
        }

        const lastNameError = validateName(lastName.value, 'Last name');
        if (lastNameError) {
            showFieldError(lastName, lastNameError);
            hasErrors = true;
        } else {
            clearFieldError(lastName);
        }

        const emailError = validateEmail(email.value);
        if (emailError) {
            showFieldError(email, emailError);
            hasErrors = true;
        } else {
            clearFieldError(email);
        }

        const phoneError = validatePhone(phone.value);
        if (phoneError) {
            showFieldError(phone, phoneError);
            hasErrors = true;
        } else {
            clearFieldError(phone);
        }

        const passwordError = validatePassword(password.value);
        if (passwordError) {
            showFieldError(password, passwordError);
            hasErrors = true;
        } else {
            clearFieldError(password);
        }

        if (password.value !== confirmPassword.value) {
            showFieldError(confirmPassword, 'Passwords do not match');
            hasErrors = true;
        } else {
            clearFieldError(confirmPassword);
        }

        if (!termsCheckbox.checked) {
            Swal.fire({
                title: 'Terms Required',
                text: 'Please agree to the Terms of Service and Privacy Policy',
                icon: 'warning',
                confirmButtonText: 'OK',
                confirmButtonColor: '#212529'
            });
            hasErrors = true;
        }

        if (hasErrors) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Please fix the errors above before submitting',
                icon: 'error',
                confirmButtonText: 'OK',
                confirmButtonColor: '#212529'
            });
            return false;
        }

        // Show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

        // Submit form
        form.submit();
    });
});
</script>

<%- include('../partials/footer') %>
